$(document).ready(function(){function t(t){var e=[],n=1/0,o=-1/0;for(var a in t.features){var i=t.features[a].properties;for(var r in i)"id"!=r&&"name"!=r&&"lat"!=r&&"lon"!=r&&(-1===$.inArray(r,e)&&e.push(r),i[r]<n&&(n=i[r]),i[r]>o&&(o=i[r]))}return{timestamps:e,min:n,max:o}}function e(t,e){l=L.geoJson(e,{pointToLayer:function(t,e){return L.circleMarker(e,{fillColor:"#708598",color:"#537898",weight:1,fillOpacity:.6}).on({mouseover:function(){this.openPopup(),this.setStyle({color:"yellow"})},mouseout:function(){this.closePopup(),this.setStyle({color:"#537898"})}})}}).addTo(s),n(t[0])}function n(t){l.eachLayer(function(e){var n=e.feature.properties,a=o(n[t]),i="<b>"+String(n[t])+" units</b><br><i>"+n.name+"</i> in </i>"+t+"</i>";e.setRadius(a),e.bindPopup(i,{offset:new L.Point(0,-a)})})}function o(t){var e=48,n=t*e;return Math.sqrt(n/Math.PI)}function a(t,e){function n(t){return 10*Math.round(t/10)}10>t&&(t=10);var a=L.control({position:"bottomright"});a.onAdd=function(){var a,i,r,l=L.DomUtil.create("div","legend"),s=L.DomUtil.create("div","symbolsContainer"),u=[n(t),n((e-t)/2),n(e)],d=0;L.DomEvent.addListener(l,"mousedown",function(t){L.DomEvent.stopPropagation(t)}),$(l).append("<h2 id='legendTitle'># of somethings</h2>");for(var p=0;p<=u.length-1;p++)a=L.DomUtil.create("div","legendCircle"),i=o(u[p]),r=-i-d-2,$(a).attr("style","width: "+2*i+"px; height: "+2*i+"px; margin-left: "+r+"px"),$(a).append("<span class='legendValue'>"+u[p]+"<span>"),$(s).append(a),d=i;return $(l).append(s),l},a.addTo(s)}function i(t){var e=L.control({position:"bottomleft"});e.onAdd=function(){var e=L.DomUtil.create("input","range-slider");return L.DomEvent.addListener(e,"mousedown",function(t){L.DomEvent.stopPropagation(t)}),$(e).attr({type:"range",max:6,min:0,step:1,value:0}).on("input change",function(){n(t[$(this).val()]),$(".temporal-legend").text(t[this.value])}),e},e.addTo(s),r(t[0])}function r(t){var e=L.control({position:"bottomleft"});e.onAdd=function(){var t=L.DomUtil.create("output","temporal-legend");return t},e.addTo(s),$(".temporal-legend").text(t)}var l,s=L.map("map",{center:[37.8,-96],zoom:4,minZoom:4});L.tileLayer("http://{s}.acetate.geoiq.com/tiles/acetate/{z}/{x}/{y}.png",{attribution:"Acetate tileset from GeoIQ"}).addTo(s),$.getJSON("data/city-data.json").done(function(n){var o=t(n);e(o.timestamps,n),a(o.min,o.max),i(o.timestamps)}).fail(function(){alert("There has been a problem loading the data.")})});